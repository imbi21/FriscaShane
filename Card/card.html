<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Our Love Story ‚Äì Seamless Nightfall</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Cormorant Garamond', serif;
      overflow-x: hidden;
      background: #2c3845;
      transition: background 2s ease;
      cursor: none;
    }
    body.night { background: #0a0c14; }
    body.loaded { transition: opacity 0.8s ease; }

    #cursor {
      position: fixed; width: 40px; height: 40px; pointer-events: none;
      z-index: 9999; top: 0; left: 0;
    }
    #cursor .heart {
      width: 30px; height: 30px;
      filter: drop-shadow(0 0 8px #ff4d88) drop-shadow(0 0 16px #ff99cc);
      transform: translate(-50%, -50%);
    }

    .sparkle {
      position: fixed; width: 5px; height: 5px; background: white;
      border-radius: 50%; pointer-events: none;
      animation: fade 0.8s forwards;
    }
    @keyframes fade { to { opacity: 0; transform: scale(2); } }

    .scene {
      height: 100vh; display: flex; justify-content: center;
      align-items: center; perspective: 1200px; opacity: 0;
      transition: opacity 1s ease;
    }
    body.loaded .scene { opacity: 1; }
    .wrapper {
      position: relative; width: 400px; height: 260px; cursor: pointer;
      outline: none;
    }
    .wrapper:focus-visible {
      outline: 2px solid #ff99cc;
      outline-offset: 8px;
      border-radius: 12px;
    }
    .envelope {
      position: absolute; width: 100%; height: 100%; background: #f3b6c6;
      border-radius: 10px; box-shadow: 0 20px 40px rgba(0,0,0,0.2), 0 5px 15px rgba(0,0,0,0.3);
      transition: opacity 1s ease;
    }
    .flap {
      position: absolute; width: 100%; height: 100%; background: #e89ab2;
      clip-path: polygon(0 0, 100% 0, 50% 65%);
      transform-origin: top; transition: transform 1s ease;
      backface-visibility: hidden;
    }
    .letter {
      position: absolute; width: 92%; left: 4%; bottom: 8%;
      background: rgba(255, 250, 242, 0.98);
      backdrop-filter: blur(2px);
      border-radius: 8px; padding: 40px; transform: translateY(0) scaleY(0);
      transform-origin: bottom; transition: all 1.2s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,.2);
    }
    .letter::before {
      content: ""; position: absolute; top: 0; bottom: 0;
      left: 25px; width: 2px; background: #f4a3b8;
    }
    .text { 
      margin-left: 20px; font-size: 18px; line-height: 30px; 
      color: #3a2f2f; white-space: pre-wrap; 
    }
    .signature {
      margin-left: 20px; margin-top: 30px; font-family: 'Dancing Script', cursive;
      font-size: 28px; color: #e75480; opacity: 0;
      transition: opacity 1.5s ease;
    }
    .open .flap { transform: rotateX(-180deg); }
    .open .letter { transform: translateY(-180px) scaleY(1); }
    .open .envelope { opacity: 0; }

    .section {
      min-height: 100vh; 
      padding: 80px 5%; 
      font-size: 22px; 
      line-height: 1.8; 
      color: white; 
      position: relative;
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      text-align: center;
      text-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    .section h2 {
      font-family: 'Dancing Script', cursive; 
      font-size: clamp(32px, 6vw, 48px); 
      margin-bottom: 30px; 
      width: 100%;
    }
    .section > div:not(.special) {
      max-width: 800px; 
      width: 100%;
    }

    #chapter2 {
      background: linear-gradient(to bottom, #4a4e69, #3a4055, #2a2f44);
      position: relative;
      z-index: 2;
      box-shadow: 0 -20px 40px rgba(0,0,0,0.2) inset;
    }

    #chapter3 {
      background: radial-gradient(circle at 50% 30%, #2c3845, #0b0e14);
      position: relative;
      box-shadow: 0 0 80px rgba(0,0,0,0.8) inset, 0 -10px 60px rgba(255,200,220,0.2);
      overflow: hidden;
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center;
      padding: 60px 20px;
      z-index: 3;
    }

    #chapter3::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 150px;
      background: linear-gradient(to bottom, rgba(44,56,69,0.95), rgba(11,14,20,0));
      pointer-events: none;
      z-index: 1;
    }

    #chapter3 h2 {
      animation: floatGlow 4s ease-in-out infinite alternate;
      text-shadow: 0 0 15px rgba(255,220,240,0.9);
      margin-bottom: 20px;
      position: relative;
      z-index: 5;
    }
    @keyframes floatGlow {
      0% { transform: translateY(0); text-shadow: 0 0 10px #fff, 0 0 20px #ffaacc; }
      100% { transform: translateY(-5px); text-shadow: 0 0 25px #ffb6c1, 0 0 45px #ff99cc; }
    }

    .castle-container {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      margin: 20px auto 10px;
      position: relative;
      z-index: 10;
    }

    #castle {
      position: relative;
      width: min(520px, 85vw);
      height: min(520px, 85vw);
      background: transparent;
      overflow: visible;
      margin: 0 auto;
    }

    #castle #table {
      position: absolute;
      left: 50%;
      top: 132%;
      transform: translate(-50%, -50%) scaleY(0.225);
      width: 400px;
      height: 400px;
      background: radial-gradient(#a3727e, #af7279, #a16674);
      border-radius: 100%;
      border-bottom: 80px solid #623c53;
      transform-origin: center;
    }

    .shade-wrap { 
      position: absolute; 
      left: 50%; 
      top: 100%; 
      transform: translate(-50%, -50%);
      width: 200px; 
      height: 400px; 
    }

    #shade-main {
      position: absolute; 
      left: 20px;  
      top: 100px;   
      width: 160px; 
      height: 250px;
      border-top: 1px solid rgba(255,255,255,0.5); 
      border-left: 1px solid rgba(255,255,255,0.5);
      border-right: 1px solid rgba(255,255,255,0.6); 
      border-top-left-radius: 50% 30%;
      border-top-right-radius: 50% 30%; 
      border-bottom: none;
      transform: perspective(200px) rotateX(8deg) scale(1.075,1);
    }

    #shade-handle-big {
      position: absolute; left: 55px; top: -14px; width: 50px; height: 30px;
      border-radius: 100%; border-top: 1px solid rgba(255,255,255,0.7); transform: scaleY(0.9);
    }
    #shade-handle-small {
      position: absolute; left: 70px; top: -33px; width: 20px; height: 20px;
      border-radius: 100%; border: 1px solid rgba(255,255,255,0.5); border-bottom: none;
    }
    #bottom-shade {
      position: absolute; bottom: -25px; width: 100%; height: 50px; transform: scaleY(0.5);
      border-radius: 100%; background: radial-gradient(#d287a5, #da9db6, #985e74);
      animation: floatAnimate 1.75s ease-in-out infinite;
    }

    #shade-main-reflections {
      position: absolute;
      left: 20px;
      top: 100px;
      width: 160px; 
      height: 250px;
      border-top-left-radius: 50% 30%; 
      border-top-right-radius: 50% 30%; 
      border-bottom: none;
      background: #6d6179; 
      transform: perspective(200px) rotateX(8deg) scale(1.075,1); 
      opacity: 0.15;
    }
    #shade-main-reflections::after {
      content: ""; 
      position: absolute; 
      left: -25px; 
      top: 0; 
      width: 160px; 
      height: 250px;
      border-top-right-radius: 30% 30%; 
      border-right: 50px solid rgba(255,255,255,0.5);
      transform: scale(0.7,0.85); 
      filter: blur(5px);
    }
    #shade-main-reflections::before {
      content: ""; 
      position: absolute; 
      left: -15px; 
      width: 100%; 
      height: 100%;
      border-top-left-radius: 50% 30%; 
      border-left: 8px solid rgba(255,255,255,0.6);
      transform: scale(0.85,0.85); 
      filter: blur(5px);
    }

  #flower-wrap { 
  position: absolute;
  top: 10px;
  left: 0px;
  cursor: pointer;
  z-index: 100;
  pointer-events: auto; 
}
    
    #flower-wrap * {
      pointer-events: none;
    }

    #stem {
      position: absolute; left: 82px; top: 187px; width: 100px; height: 150px; background: transparent;
      border: solid 4px #a1b965; border-color: transparent transparent transparent #a1b965;
      border-radius: 50%/120px 100px 0 0; transform: rotate(-3deg) scale(1.1,0.9);
    }

    #petal1 { position: absolute; left: 97px; top: 188px; width: 25px; height: 25px; border-top-left-radius: 50% 10%; border-top-right-radius: 50% 40%; border-bottom-left-radius: 50% 10%; border-bottom-right-radius: 50% 40%; background-color: #c82b60; transform: rotate(32deg) scale(1.6); box-shadow: 1px -1px 1px 0 #6f1232; }
    #petal1::before, #petal1::after { content: ""; position: absolute; left: 0; width: 100%; height: 100%; border-radius: inherit; opacity: 0.9; }
    #petal1::before { box-shadow: 0 0 10px 0 #e8b2ca; }
    #petal1::after { animation: glow 3s ease-in-out infinite; }

    #petal2 { position: absolute; left: 85px; top: 185px; width: 25px; height: 30px; border-top-left-radius: 50% 10%; border-top-right-radius: 50% 50%; border-bottom-left-radius: 50% 50%; border-bottom-right-radius: 50% 10%; background-color: #d05478; transform: rotate(35deg) scale(1.2, 1); box-shadow: 1px -1px 1px 0 #6f1232; opacity: 0.9; }
    #petal3 { position: absolute; left: 105px; top: 197px; width: 25px; height: 28px; border-top-left-radius: 50% 50%; border-top-right-radius: 10% 10%; border-bottom-left-radius: 10% 10%; border-bottom-right-radius: 50% 50%; background-color: #cb5275; transform: rotate(25deg) scale(1, 1.05) skew(-8deg); box-shadow: 1px -1px 1px 0 #6f1232; opacity: 0.9; }
    #petal4 { position: absolute; left: 80px; top: 191px; width: 25px; height: 25px; border-top-left-radius: 50% 10%; border-top-right-radius: 50% 50%; border-bottom-left-radius: 50% 50%; border-bottom-right-radius: 50% 10%; background-color: #d26484; transform: rotate(30deg) scale(1.1, 0.9) skew(10deg); box-shadow: 1px -1px 1px 0 #a53d60; opacity: 0.9; }
    #petal5 { position: absolute; left: 105px; top: 207px; width: 25px; height: 20px; border-top-left-radius: 50% 50%; border-top-right-radius: 10% 10%; border-bottom-left-radius: 10% 10%; border-bottom-right-radius: 50% 50%; background-color: #d26484; transform: rotate(28deg) scale(1, 1.05) skew(-18deg); box-shadow: 1px -1px 1px 0 #a53d60; opacity: 0.9; }
    #falling-petal { position: absolute; left: 105px; top: 209px; width: 22px; height: 18px; border-top-left-radius: 50% 50%; border-top-right-radius: 10% 10%; border-bottom-left-radius: 10% 10%; border-bottom-right-radius: 50% 50%; background-color: #da7290; transform: rotate(32deg) scale(0.9, 0.95) skew(-18deg); box-shadow: 1px -1px 1px 0 #a53d60; opacity: 0.9; animation: 7s fall 4s ease-in-out infinite; }
    #leaf1 { position: absolute; left: 75px; top: 225px; width: 13px; height: 20px; border-top-left-radius: 50% 10%; border-top-right-radius: 50% 50%; border-bottom-left-radius: 50% 50%; border-bottom-right-radius: 50% 10%; background-color: #a1b965; transform: rotate(5deg); }
    #leaf2 { position: absolute; left: 82px; top: 265px; width: 12px; height: 16px; border-top-left-radius: 50% 10%; border-top-right-radius: 50% 50%; border-bottom-left-radius: 50% 50%; border-bottom-right-radius: 50% 10%; background-color: #a1b965; transform: rotate(-97deg); }

    @keyframes glow { 0% { box-shadow:0 0 25px 0 #e8b2ca; } 50% { box-shadow:0 0 45px 0 #e8b2ca; } 100% { box-shadow:0 0 25px 0 #e8b2ca; } }
    @keyframes fall {
      5% { top:209px; left:105px; transform:rotate(55deg) scale(0.9,0.95) skew(-18deg); opacity:0.9; }
      30% { left:90px; } 55% { left:130px; }
      60%,100% { top:380px; transform:rotate(30deg) scale(0.9,0.95) skew(-32deg); opacity:0; }
    }
    @keyframes floatAnimate {
      0% { background-size:105% 120%; opacity:.7; }
      50% { background-size:100% 100%; opacity:0.5; }
      100% { background-size:105% 120%; opacity:.7; }
    }

    .shade-wrap.hover-animation {
      animation: hoverCentered 2s ease-in-out infinite;
    }
    @keyframes hoverCentered {
      0% { transform: translate(-50%, -50%) translateY(8px); }
      50% { transform: translate(-50%, -50%) translateY(-6px); }
      100% { transform: translate(-50%, -50%) translateY(8px); }
    }

    #chapter3-dust {
      position: absolute; width: 100%; height: 100%;
      pointer-events: none; overflow: hidden; top: 0; left: 0;
      z-index: 5;
    }
    .dustDef {
      position: absolute; background: white; border-radius: 50%;
      box-shadow: 0 0 4px 2px rgba(255,255,240,0.8); opacity: 0;
    }

    .moon {
      position: fixed; width: 120px; height: 120px;
      background: radial-gradient(circle, #fff, #ddd); border-radius: 50%;
      top: 110%; right: 10%; box-shadow: 0 0 40px #fff;
      transition: top 3s ease; z-index: -1;
    }
    body.night .moon { top: 10%; }
    .star {
      position: fixed; width: 2px; height: 2px;
      background: white; border-radius: 50%;
    }
    .shooting {
      position: fixed; width: 120px; height: 2px;
      background: linear-gradient(to right, white, transparent);
      transform: rotate(45deg); animation: shoot 1s linear forwards;
    }
    @keyframes shoot {
      from { opacity: 1; transform: translateX(0) translateY(0) rotate(45deg); }
      to { opacity: 0; transform: translateX(300px) translateY(300px) rotate(45deg); }
    }

    .firefly {
      position: fixed; width: 6px; height: 6px; 
      background: #ffe066;
      border-radius: 50%; 
      box-shadow: 0 0 12px 2px #ffd700, 0 0 25px 4px #ffb347;
      opacity: 0;
      transition: transform 0.1s ease;
      pointer-events: none;
      z-index: 100;
    }

    .progress-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 0%;
      height: 3px;
      background: linear-gradient(to right, #ff99cc, #ff4d88);
      z-index: 10000;
      transition: width 0.1s ease;
    }

    .folder-hint {
      position: fixed;
      bottom: 30px;
      left: 30px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(5px);
      color: rgba(255, 255, 255, 0.8);
      padding: 12px 24px;
      border-radius: 40px;
      font-family: 'Dancing Script', cursive;
      font-size: 18px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 20px rgba(255, 200, 220, 0.3);
      z-index: 1000;
      pointer-events: none;
    }

    .folder-hint span {
      color: #ff99cc;
      font-weight: bold;
    }

    @media (max-width: 600px) {
      .section { padding: 60px 20px; }
      .wrapper { width: 320px; height: 208px; }
      .letter { padding: 20px; }
      .text { font-size: 16px; line-height: 26px; margin-left: 15px; }
      .signature { font-size: 22px; }
      .text::before { left: 15px; }
      #castle { width: min(400px, 95vw); height: min(400px, 95vw); }
      #shade-main { left: 15px; top: 80px; width: 140px; height: 220px; }
      #shade-main-reflections { left: 15px; top: 80px; width: 140px; height: 220px; }
      #flower-wrap { transform: scale(0.85); left: -25px; top: 20px; }
      .folder-hint { bottom: 20px; left: 20px; font-size: 16px; padding: 10px 20px; }
    }
  </style>
</head>
<body>
  <div id="cursor">
    <svg class="heart" viewBox="0 0 32 29">
      <path d="M23.6,0c-2.8,0-5.2,1.5-6.6,3.7C15.6,1.5,13.2,0,10.4,0C4.7,0,0,4.7,0,10.4c0,8,16,18.6,16,18.6s16-10.6,16-18.6C32,4.7,27.3,0,23.6,0z" fill="#ff4d88"/>
    </svg>
  </div>

  <div class="moon"></div>
  <div class="progress-bar"></div>
  
  <div class="folder-hint">
    üìÅ FriscaShane / <span>Card</span> / Garden
  </div>

  <div class="scene">
    <div class="wrapper" id="wrapper" role="button" aria-label="Open love letter" tabindex="0">
      <div class="letter" id="letter">
        <div class="text" id="typed"></div>
        <div class="signature" id="sign">Yours, in every lifetime.</div>
      </div>
      <div class="envelope"></div>
      <div class="flap"></div>
    </div>
  </div>

  <div class="section" id="chapter2">
    <h2>Chapter 2 ‚Äî The Future</h2>
    <div>When the stars awaken, I still choose you. In quiet moments. In loud laughter. In every lifetime.</div>
  </div>

  <div class="section" id="chapter3">
    <h2>Chapter 3 ‚Äî Always</h2>
    <div style="max-width: 700px; margin-bottom: 10px;">
      Beyond the moonlight, beyond the dawn, our story continues ‚Äî soft, infinite, and eternal.
    </div>
    
    <div class="castle-container">
      <div id="castle">
        <div id="table"></div>
        <div class="shade-wrap hover-animation" id="main">
          <div id="flower-wrap" onclick="window.location.href='Garden/garden.html'" style="cursor: pointer; pointer-events: auto;">
            <div id="stem"></div>
            <div id="petal1"></div><div id="petal2"></div><div id="petal3"></div>
            <div id="petal4"></div><div id="petal5"></div>
            <div id="falling-petal"></div>
            <div id="leaf1"></div><div id="leaf2"></div>
            </div>
        </div>
        <div class="shade-wrap" id="sub" onclick="window.location.href='Garden/garden.html'" style="cursor: pointer; pointer-events: auto;">
  <div id="shade-main-reflections"></div>
  <div id="shade-main">
    <div id="shade-handle-big"></div>
    <div id="shade-handle-small"></div>
    <div id="bottom-shade" onclick="window.location.href='Garden/garden.html'" style="cursor: pointer; pointer-events: auto;"></div>
  </div>
</div>
        </div>
      </div>
    </div>
    
    <div id="chapter3-dust"></div>
  </div>

  <audio id="bgMusic" loop preload="auto">
    <source src="https://www.bensound.com/bensound-music/bensound-romantic.mp3" type="audio/mpeg">
  </audio>

  <script>
    (function() {
      "use strict";

      const wrapper = document.getElementById('wrapper');
      const typed = document.getElementById('typed');
      const sign = document.getElementById('sign');
      const cursor = document.getElementById('cursor');
      const music = document.getElementById('bgMusic');
      const body = document.body;
      const chapter3 = document.getElementById('chapter3');

      let opened = false;
      let starsCreated = false;
      let flies = [];
      let dustInitialized = false;
      let shootingInterval = null;
      
      const progressBar = document.querySelector('.progress-bar');
      window.addEventListener('scroll', () => {
        const winScroll = body.scrollTop || document.documentElement.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = (winScroll / height) * 100;
        progressBar.style.width = scrolled + '%';
      }, { passive: true });

      body.classList.add('loaded');

      let sparkleLastTime = 0;
      document.addEventListener('mousemove', (e) => {
        cursor.style.left = e.clientX + 'px';
        cursor.style.top = e.clientY + 'px';
        
        const now = Date.now();
        if (now - sparkleLastTime > 32) {
          sparkleLastTime = now;
          const s = document.createElement('div');
          s.className = 'sparkle';
          s.style.left = e.clientX + 'px';
          s.style.top = e.clientY + 'px';
          body.appendChild(s);
          setTimeout(() => s.remove(), 800);
        }
      });

      wrapper.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          wrapper.click();
        }
      });

      const msg = `My love,\n\nEvery day with you feels warmer,\nbrighter, and magical.\n\nNo matter where life takes us,\nyou are my favorite place to return to.\n\nI'm so grateful for you.\nAlways.`;
      let i = 0;
      function typeWriter() {
        if (i < msg.length) {
          typed.innerHTML += msg[i];
          i++;
          setTimeout(typeWriter, 35);
        } else {
          sign.style.opacity = 1;
        }
      }

      wrapper.addEventListener('click', () => {
        if (!opened) {
          wrapper.classList.add('open');
          setTimeout(typeWriter, 1000);
          opened = true;
        } else {
          wrapper.classList.remove('open');
          typed.innerHTML = '';
          sign.style.opacity = 0;
          i = 0;
          opened = false;
        }
      });

      window.addEventListener('scroll', () => {
        if (window.scrollY > 200 && !starsCreated) {
          body.classList.add('night');
          starsCreated = true;
          createStars(140);
          createFireflies(72);
          
          if (!dustInitialized) {
            initMagicDust();
            dustInitialized = true;
          }
          
          music.volume = 0;
          const playPromise = music.play();
          if (playPromise !== undefined) {
            playPromise.catch(() => {
              if (!document.querySelector('.music-btn')) {
                const playBtn = document.createElement('button');
                playBtn.textContent = '‚ú® Play Music ‚ú®';
                playBtn.className = 'music-btn';
                playBtn.style.cssText = 'position:fixed; bottom:20px; right:20px; background:#ff99cc; border:none; color:white; padding:10px 18px; border-radius:40px; font-family:Dancing Script; font-size:18px; box-shadow:0 0 20px #ff99cc; cursor:pointer; z-index:1000; border:1px solid white;';
                playBtn.addEventListener('click', () => {
                  music.play();
                  playBtn.remove();
                });
                body.appendChild(playBtn);
              }
            });
          }
          fadeMusic(0.3);
          if (!shootingInterval) {
            shootingInterval = setInterval(createShootingStar, 4200);
          }
        }

        const chapter2 = document.getElementById('chapter2');
        if (chapter2) {
          const rect2 = chapter2.getBoundingClientRect();
          const progress = Math.max(0, Math.min(1, (window.innerHeight - rect2.bottom) / 200));
          chapter2.style.boxShadow = `inset 0 -${20 + progress * 40}px ${30 + progress * 30}px rgba(0,0,0,${0.2 + progress * 0.3})`;
        }
      }, { passive: true });

      window.addEventListener('scroll', () => {
        if (!chapter3) return;
        const rect = chapter3.getBoundingClientRect();
        const isVisible = rect.top < window.innerHeight && rect.bottom > 50;
        if (!isVisible && flies.length > 0) {
          flies.forEach(fly => { if (fly.parentNode) fly.remove(); });
          flies = [];
        } else if (isVisible && flies.length === 0 && starsCreated) {
          createFireflies(72);
        }
      }, { passive: true });

      function createStars(count) {
        for (let i = 0; i < count; i++) {
          const star = document.createElement('div');
          star.className = 'star';
          star.style.left = Math.random() * 100 + 'vw';
          star.style.top = Math.random() * 100 + 'vh';
          star.style.animation = `twinkle ${2 + Math.random() * 3}s infinite`;
          body.appendChild(star);
        }
        const style = document.createElement('style');
        style.textContent = '@keyframes twinkle { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }';
        document.head.appendChild(style);
      }

      function createShootingStar() {
        const shoot = document.createElement('div');
        shoot.className = 'shooting';
        shoot.style.top = Math.random() * 50 + 'vh';
        shoot.style.left = Math.random() * 50 + 'vw';
        body.appendChild(shoot);
        setTimeout(() => shoot.remove(), 1000);
      }

      function createFireflies(count) {
        if (flies.length > 0) {
          flies.forEach(f => f.remove());
          flies = [];
        }
        
        for (let i = 0; i < count; i++) {
          const fly = document.createElement('div');
          fly.className = 'firefly';
          body.appendChild(fly);
          
          fly.x = Math.random() * window.innerWidth;
          fly.y = Math.random() * window.innerHeight;
          fly.vx = (Math.random() - 0.5) * 0.6;
          fly.vy = (Math.random() - 0.5) * 0.6;
          fly.style.background = i % 3 === 0 ? '#ffdd77' : (i % 3 === 1 ? '#ffe066' : '#ffd966');
          fly.style.boxShadow = `0 0 ${12 + i % 10}px 2px #ffd700, 0 0 ${20 + i % 15}px 4px #ffb347`;
          fly.style.width = `${5 + (i % 3)}px`;
          fly.style.height = `${5 + (i % 3)}px`;
          
          flies.push(fly);
        }

        function onMouseMove(e) {
          if (!chapter3) return;
          const rect = chapter3.getBoundingClientRect();
          const isVisible = rect.top < window.innerHeight && rect.bottom > 50;
          if (!isVisible) return;
          
          flies.forEach(f => {
            if (!f.parentNode) return;
            const dx = e.clientX - f.x;
            const dy = e.clientY - f.y;
            const dist = Math.hypot(dx, dy);
            if (dist < 180) {
              f.vx += dx * 0.0018;
              f.vy += dy * 0.0018;
            }
          });
        }
        document.removeEventListener('mousemove', onMouseMove);
        document.addEventListener('mousemove', onMouseMove);

        function updateFireflies() {
          flies.forEach(f => {
            if (!f.parentNode) return;
            f.x += f.vx;
            f.y += f.vy;
            f.vx *= 0.99;
            f.vy *= 0.99;

            if (f.x < -20) f.x = window.innerWidth + 20;
            if (f.x > window.innerWidth + 20) f.x = -20;
            if (f.y < -20) f.y = window.innerHeight + 20;
            if (f.y > window.innerHeight + 20) f.y = -20;

            f.style.left = f.x + 'px';
            f.style.top = f.y + 'px';
            f.style.opacity = 0.6 + 0.4 * Math.sin(Date.now() * 0.002 + f.x);
          });
          requestAnimationFrame(updateFireflies);
        }
        requestAnimationFrame(updateFireflies);
      }

      function fadeMusic(target) {
        let vol = 0;
        const fade = setInterval(() => {
          if (vol < target) {
            vol = Math.min(target, vol + 0.015);
            music.volume = vol;
          } else {
            clearInterval(fade);
          }
        }, 200);
      }

      function initMagicDust() {
        const dustContainer = document.getElementById('chapter3-dust');
        if (!dustContainer) return;
        let animId = 1;
        const head = document.head;
        const isMobile = window.innerWidth < 600;

        function createDust(x1, x2, y1, y2, sizeRatio, duration, delay) {
          const animName = `dustGlow${animId++}`;
          const style = document.createElement('style');
          style.textContent = `@keyframes ${animName} {
            0% { top: ${y1}px; left: ${x1}px; width: ${2*sizeRatio}px; height: ${2*sizeRatio}px; opacity: 0.6; }
            30% { width: ${4*sizeRatio}px; height: ${4*sizeRatio}px; opacity: 1; }
            60% { width: ${2*sizeRatio}px; height: ${2*sizeRatio}px; opacity: 0.7; }
            100% { top: ${y2}px; left: ${x2}px; width: 0px; height: 0px; opacity: 0; }
          }`;
          head.appendChild(style);
          const dust = document.createElement('span');
          dust.className = 'dustDef';
          dust.style.animation = `${animName} ${duration}s ease-in-out infinite ${delay}s`;
          dustContainer.appendChild(dust);
        }

        for (let i = 0; i < 12; i++) {
          let baseX = 85 + Math.random() * 30;
          let baseY = 185 + Math.random() * 30;
          createDust(baseX, baseX + (Math.random() - 0.5) * 25, baseY, baseY + (Math.random() - 0.5) * 25, 0.4 + Math.random()*0.3, 1.8 + Math.random(), Math.random() * 2);
        }

        for (let i = 0; i < 10; i++) {
          let baseX = 50 + Math.random() * 120;
          let baseY = 330 + Math.random() * 60;
          createDust(baseX, baseX + (Math.random() - 0.5) * 20, baseY, baseY + (Math.random() - 0.5) * 15, 0.3 + Math.random()*0.3, 1.5 + Math.random(), Math.random() * 2);
        }

        for (let i = 0; i < 8; i++) {
          let baseX = 45 + Math.random() * 60;
          let baseY = 80 + Math.random() * 60;
          createDust(baseX, baseX + (Math.random() - 0.5) * 20, baseY, baseY + (Math.random() - 0.5) * 20, 0.2 + Math.random()*0.2, 2 + Math.random(), Math.random() * 2.5);
        }
      }

      window.addEventListener('load', () => {
        if (window.scrollY > 200) {
          body.classList.add('night');
          if (!starsCreated) {
            starsCreated = true;
            createStars(140);
            createFireflies(72);
            initMagicDust();
            dustInitialized = true;
            music.volume = 0; 
            music.play().catch(() => {});
            fadeMusic(0.3);
            shootingInterval = setInterval(createShootingStar, 4200);
          }
        }
      });

    })();
  </script>
</body>
</html>
